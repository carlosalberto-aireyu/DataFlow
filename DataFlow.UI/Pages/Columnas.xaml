<Page x:Class="DataFlow.UI.Pages.Columnas"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:DataFlow.UI.Pages" xmlns:viewmodels="clr-namespace:DataFlow.UI.ViewModels" 
      d:DataContext="{d:DesignInstance Type=viewmodels:ConfigColumnsViewModel}"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="1200"
      Title="Columnas">

    <Grid Margin="12" Background="#F7F7F7">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" Margin="0,0,0,8" >
            <TextBlock Text="{Binding SelectedTemplateDescription, StringFormat='Plantilla: {0}'}"  
                       Style="{StaticResource PageColumnasStyle}" DockPanel.Dock="Left"/>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right">
                <Button Style="{StaticResource IconOnlyButtonStyle}"
                    Click="AddColumnButton_Click"
                    ToolTip="Agregar Columna"
                    Tag="M0,5 L10,5 M5,0 L5,10"/>

                <Button Style="{StaticResource IconOnlyButtonStyle}"
                    ToolTip="Editar Columna"
                    Click="EditColumnButton_Click"
                    Tag="M17,3 L21,7 L7,21 L3,21 L3,17 L17,3"/>

                <Button Style="{StaticResource IconOnlyButtonStyle}"
                    ToolTip="Actualizar"
                    Command="{Binding RefreshCommand}"
                    Tag="M12,4 V7 A7,7 0 0 1 19,14 H16 M12,20 V17 A7,7 0 0 1 5,10 H8 M12,4 L15,7 L12,10 M12,20 L9,17 L12,14"/>

                <Button Style="{StaticResource IconOnlyButtonStyle}"
                    ToolTip="Eliminar Columna"
                    Click="DeleteColumnButton_Click"
                    Tag="M3,6 H21 M8,6 V4 H16 V6 M19,6 V20 C19,21 18,22 17,22 H7 C6,22 5,21 5,20 V6 M10,11 V17 M14,11 V17"/>

                <TextBox x:Name="FilterInput"
                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     Style="{StaticResource FilterTextBoxStyle}"
                     Width="250"
                     BorderBrush="#CCCCCC"
                     BorderThickness="1"/>
            </StackPanel>
        </DockPanel>

        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            


            <Grid Grid.Row="0" Margin="0,0,6,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Columna(s) :" 
                           FontWeight="Bold" FontSize="14" Margin="0,0,0,8" Foreground="#333"/>

                <DataGrid Grid.Row="2" 
                          x:Name="ColumnsDataGrid"
                          ItemsSource="{Binding FilteredColumns}"
                          Style="{StaticResource ModernDataGridStyle}"
                          RowStyle="{StaticResource ModernDataGridRowStyle}"
                          ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeaderStyle}"
                          CellStyle="{StaticResource CleanDataGridCellStyle}"
                          AutoGenerateColumns="False" 
                          CanUserAddRows="False" 
                          IsReadOnly="True" 
                          SelectionMode="Single"
                          SelectedItem="{Binding SelectedColumn, Mode=TwoWay}"
                          MouseDoubleClick="DataGrid_MouseDoubleClick"
                          >
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Orden" Binding="{Binding IndexColumn}" Width="Auto"/>
                        <DataGridTextColumn Header="Nombre" Binding="{Binding Name}" Width="Auto"/>
                        <DataGridTextColumn Header="Mostrar" Binding="{Binding NameDisplay}" Width="Auto"/>
                        <DataGridTextColumn Header="Tipo Dato" Binding="{Binding DataType.Code}" Width="Auto"/>
                        <DataGridTextColumn Header="Valor Defecto" Binding="{Binding DefaultValue}" Width="Auto"/>
                        <DataGridTextColumn Header="Tipo Columna" Binding="{Binding ColumnType.Code}" Width="Auto"/>
                        <DataGridTextColumn Header="Descripción" Binding="{Binding Description}" Width="*"/>
                        <DataGridTextColumn Header="Actualizado" Binding="{Binding UpdatedAtFormatted}" Width="Auto"/>
                    </DataGrid.Columns>
                </DataGrid>

                <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Cargando..." Foreground="#6B7280" VerticalAlignment="Center" Margin="0,0,8,0"/>
                </StackPanel>
            </Grid>

            <Grid Grid.Row="1" Margin="6,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Rangos por Columna" FontWeight="Bold" 
                           VerticalAlignment="Center"
                           FontSize="14" Margin="0,0,0,8" Foreground="#333"/>

                <!--
                <TextBlock Grid.Row="1" 
                           Text="{Binding SelectedColumn.DisplayName, StringFormat='Columna: {0}'}"
                           Foreground="#666"
                           VerticalAlignment="Center"   
                           Margin="0,0,0,8"
                           Visibility="{Binding IsColumnSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                -->


                <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,8" Visibility="{Binding IsColumnSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <!-- <Button Style="{StaticResource IconOnlyButtonStyle}"
                        Click="AddRangeButton_Click"
                        ToolTip="Agregar Rango"
                        Tag="M0,5 L10,5 M5,0 L5,10"/> -->

                    <!-- <Button Style="{StaticResource IconOnlyButtonStyle}"
                        ToolTip="Editar Rango"
                        Click="EditRangeButton_Click"
                        Tag="M17,3 L21,7 L7,21 L3,21 L3,17 L17,3"/> -->

                    <Button Style="{StaticResource IconOnlyButtonStyle}"
                        ToolTip="Eliminar Rango"
                        Click="DeleteRangeButton_Click"
                        Tag="M3,6 H21 M8,6 V4 H16 V6 M19,6 V20 C19,21 18,22 17,22 H7 C6,22 5,21 5,20 V6 M10,11 V17 M14,11 V17"/>
                </StackPanel>


                <TextBlock Grid.Row="1"
                           Text="Selecciona una columna para ver sus rangos"
                           Foreground="#999"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           FontSize="13"
                           Visibility="{Binding IsColumnSelected, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>


                <DataGrid Grid.Row="1" 
                          x:Name="RangesDataGrid"
                          ItemsSource="{Binding SelectedColumn.Ranges}"
                          Style="{StaticResource ModernDataGridStyle}"
                          RowStyle="{StaticResource ModernDataGridRowStyle}"
                          ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeaderStyle}"
                          CellStyle="{StaticResource CleanDataGridCellStyle}"
                          AutoGenerateColumns="False" 
                          CanUserAddRows="True"
                          IsReadOnly="False" 
                          SelectionMode="Single"
                          SelectedItem="{Binding SelectedRange, Mode=TwoWay}"
                          AddingNewItem="RangesDataGrid_AddingNewItem"
                          BeginningEdit="RangesDataGrid_BeginningEdit"
                          RowEditEnding="RangesDataGrid_RowEditEnding"
                            Visibility="{Binding IsColumnSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Desde" Binding="{Binding RFrom, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" Width="150"/>
                        <DataGridTextColumn Header="Hasta" Binding="{Binding RTo, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" Width="150"/>
                        <DataGridTextColumn Header="Valor por Defecto" Binding="{Binding DefaultValue, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>


        <TextBlock Grid.Row="1"
           Text="{Binding ErrorMessage}"
           Foreground="#DC2626"
           Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"
           Margin="0,8,0,0"
           TextWrapping="Wrap"/>
    </Grid>
</Page>